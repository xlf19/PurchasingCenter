<template>
  <a-card :bordered="false" :class="{ abcdefg: true }">
    <div class="table-page-search-wrapper">
      <a-form layout="inline" @keyup.enter.native="searchQuery" :form="form">
        <a-row :gutter="24">
          <a-col :xl="6" :lg="7" :md="8" :sm="24">
            <a-form-item label="合同编号">
              <a-select v-model="queryParam.contractNo" show-search allowClear @search="findHt" @change="findOne">
                <a-select-option
                  placeholder="请选择合同号"
                  :value="item"
                  v-for="(item, index) in contractNos"
                  :key="index"
                  >{{ item }}</a-select-option
                >
              </a-select>
            </a-form-item>
          </a-col>
          <a-col :xl="6" :lg="7" :md="8" :sm="24">
            <a-form-item label="凭证号">
              <a-select v-model="queryParam.voucherNo" allowClear>
                <a-select-option
                  placeholder="请选择凭证号"
                  :value="item"
                  v-for="(item, index) in voucherNos"
                  :key="index"
                  >{{ item }}</a-select-option
                >
              </a-select>
            </a-form-item>
          </a-col>
          <a-col :xl="6" :lg="7" :md="8" :sm="24">
            <span style="float: left; overflow: hidden" class="table-page-search-submitButtons">
              <a-button type="primary" @click="searchHtbh" icon="search" ghost>查询</a-button>
              <a-button v-print="'#printContent'" type="primary" style="margin-left: 8px" ghost>打印</a-button>
            </span>
          </a-col>
        </a-row>
      </a-form>
    </div>

    <section ref="print" id="printContent" class="abcdefg">
      <div style="text-align: center">
        <p style="font-size: 24px; font-weight: 800">{{ materialName }}&nbsp;&nbsp;&nbsp;结算单</p>
      </div>
      <a-row :gutter="24" style="text-align: center">
        <a-col :span="6">
          <span>执行:{{ queryParam.contractNo }} 合同标准</span>
        </a-col>
        <a-col :span="6">
          <span>供货单位:{{ supplier }}</span>
        </a-col>
        <a-col :span="6">
          <span>收货单位:{{ receivingUnit }}</span>
        </a-col>
        <a-col :span="6"
          ><span>凭证号:汇--{{ queryParam.voucherNo }}</span></a-col
        >
      </a-row>
      <!--签字-->
      <div style="margin-top: 10px">
        <a-table
          ref="table"
          size="middle"
          bordered
          style="color: black"
          rowKey="id"
          :columns="columns"
          :dataSource="dataSource"
          :pagination="false"
          :loading="loading"
        ></a-table>
      </div>
      <div>
        <a-row :gutter="24" style="text-align: center; margin-top: 10px">
          <a-col :span="24">
            <span style="font-size: 18px;">总计：货款:￥{{ loan }}+税金:￥{{ taxes }}=总金额：￥{{ zprice }}</span>
          </a-col>
        </a-row>
      </div>
      <div>
        <a-row :gutter="24" style="text-align: left; margin-top: 10px">
          <a-col :span="6"></a-col>
          <a-col :span="9">
            <span>结算人：{{ clearingHouse }}</span>
          </a-col>
          <a-col :span="9">
            <span>结算日期：{{ settlementDate }}</span>
          </a-col>
        </a-row>
      </div>
    </section>
  </a-card>
  <!--</page-layout>-->
</template>
<script>
import ACol from 'ant-design-vue/es/grid/Col'
import ARow from 'ant-design-vue/es/grid/Row'
import ATextarea from 'ant-design-vue/es/input/TextArea'
import { getAction, postAction } from '@/api/manage'
import { validateDuplicateValue, randomUUID, handleStatus, filterObj } from '@/utils/util'
import { mixinDevice } from '@/utils/mixin'
import { JeecgListMixin } from '@/mixins/JeecgListMixin'
import * as math from 'mathjs'
export default {
  mixins: [JeecgListMixin, mixinDevice],
  components: {
    ATextarea,
    ARow,
    ACol
  },
  name: 'shentieprint',
  props: {
    contrac: {
      type: String
    }
  },
  watch: {
    contrac(newVal, oldVal) {
      this.queryParam.contractNo = newVal
      this.queryParam.voucherNo = null
      this.findHt(newVal)
      this.findOne(newVal)
    }
  },
  data() {
    return {
      description: '生铁打印单页面',
      disableMixinCreated: true,
      form: this.$form.createForm(this),
      //   /* 查询条件-请不要在queryParam中声明非字符串值的属性 */
      queryParam: {
        contractNo: this.contrac
      },
      /* 数据源 */
      dataSource: [],
      //合同号
      contractNos: [],
      //凭证号
      voucherNos: [],
      //物资名称
      materialName: '',
      //供货单位
      supplier: '',
      //收货单位
      receivingUnit: '',
      //结算日期
      settlementDate: '',
      //结算人
      clearingHouse: '',
      //货款
      loan: 0,
      //行数
      numberhs: 0,
      //税金
      taxes: 0,
      //总金额
      zprice: 0,
      // 表头
      columns: [
        {
          title: '取样日期',
          align: 'center',
          dataIndex: 'weighingDate',
          customRender: function(text) {
            return !text ? '' : text.length > 10 ? text.substr(0, 10) : text
          }
        },
        {
          title: '检斤',
          align: 'center',
          dataIndex: 'weighing'
        },
        {
          title: 'CaO',
          align: 'center',
          dataIndex: 'CaO'
        },
        {
          title: 'MgO',
          align: 'center',
          dataIndex: 'MgO'
        },
        {
          title: 'SiO2',
          align: 'center',
          dataIndex: 'SiO2'
        },
        {
          title: 'P',
          align: 'center',
          dataIndex: 'P'
        },
        {
          title: 'S',
          align: 'center',
          dataIndex: 'S'
        },
        {
          title: 'CaF2',
          align: 'center',
          dataIndex: 'CaF2'
        },
        {
          title: 'LD1',
          align: 'center',
          dataIndex: 'LD1'
        },
        {
          title: 'LD2',
          align: 'center',
          dataIndex: 'LD2'
        },
        {
          title: 'KCaO',
          align: 'center',
          dataIndex: 'KCaO'
        },
        {
          title: 'KMgO',
          align: 'center',
          dataIndex: 'KMgO'
        },
        {
          title: 'KSiO2',
          align: 'center',
          dataIndex: 'KSiO2'
        },
        {
          title: 'KP',
          align: 'center',
          dataIndex: 'KP'
        },
        {
          title: 'KS',
          align: 'center',
          dataIndex: 'KS'
        },
        {
          title: 'KCaF2',
          align: 'center',
          dataIndex: 'KCaF2'
        },
        {
          title: 'KLD1',
          align: 'center',
          dataIndex: 'KLD1'
        },
        {
          title: 'KLD2',
          align: 'center',
          dataIndex: 'KLD2'
        },

        {
          title: '结算单价',
          align: 'center',
          dataIndex: 'settlemenPrice'
        },
        {
          title: '结算数量',
          align: 'center',
          dataIndex: 'settlementQuantity'
        },
        {
          title: '结算金额',
          align: 'center',
          dataIndex: 'settlementResults'
        },
        {
          title: '货款',
          align: 'center',
          dataIndex: 'loan'
        },
        {
          title: '税金',
          align: 'center',
          dataIndex: 'taxes'
        }
      ],
      url: {
        list: '/feiliao/feiliao/selectfldy',
        selectHtbh: '/contract/contractInformation/selectHtbh',
        selectHtpzh: '/contract/contractInformation/selectHtpzh'
      },
      dictOptions: {}
    }
  },
  created() {
    let hth = this.queryParam.contractNo
    this.findHt(hth)
    if (hth != '' && hth != null) {
      this.findOne(hth)
    }
  },
  methods: {
    //获取合同号
    findHt(hth) {
      getAction(this.url.selectHtbh, { htbh: hth, httype: '辅料' }).then(res => {
        if (res.success) {
          this.contractNos = res.result
        }
        if (res.code === 510) {
          this.$message.warning(res.message)
        }
        this.loading = false
      })
    },

    findOne(hth) {
      getAction(this.url.selectHtpzh, { htbh: hth, httype: '辅料' }).then(res => {
        if (res.success) {
          this.voucherNos = res.result
        }
        if (res.code === 510) {
          this.$message.warning(res.message)
        }
        this.loading = false
      })
    },

    searchHtbh() {
      let contractNo = this.queryParam.contractNo
      let voucherNo = this.queryParam.voucherNo
      if (contractNo === '' || contractNo === null) {
        this.$message.warning('请选择合同号')
        return
      }
      if (voucherNo === '' || voucherNo === null || voucherNo === undefined) {
        this.$message.warning('请选择凭证号')
        return
      }
      var params = this.getQueryParams() //查询条件
      this.loading = true
      getAction(this.url.list, params).then(res => {
        if (res.success) {
          if (res.result.records.length > 0) {
            this.numberhs = res.result.records.length
            this.materialName = res.result.records[0].materialName
            this.supplier = res.result.records[0].supplier
            this.receivingUnit = res.result.records[0].receivingUnit
            this.settlementDate = res.result.records[0].settlementDate
            this.clearingHouse = res.result.records[0].clearingHouse
            this.dataSource = res.result.records
            this.ipagination.total = res.result.total
            this.tableAddTotalRow(this.columns, this.dataSource)
          }
        }
        if (res.code === 510) {
          this.$message.warning(res.message)
        }

        this.loading = false
      })
    },
    printFn(value) {
      const precision = 14
      return Number(math.format(value, precision))
    },
    /** 表格增加合计行 */
    tableAddTotalRow(columns, dataSource) {
      let numKey = 'weighingDate'
      let numberhs = this.numberhs
      let totalRow = { [numKey]: '合计' }
      columns.forEach(column => {
        let { key, dataIndex } = column
        if (![key, dataIndex].includes(numKey)) {
          let total = 0
          dataSource.forEach(data => {
            if (data[dataIndex] === null || data[dataIndex] === '' || dataIndex === undefined) {
              data[dataIndex] = 0
            }
            total = this.printFn(
              total +
                (/^[-+]?(([0-9]+)([.]([0-9]+))?|([.]([0-9]+))?)$/.test(data[dataIndex])
                  ? Number.parseFloat(data[dataIndex])
                  : Number.NaN)
            )
          })
          if (Number.isNaN(total)) {
            total = '-'
          }
          totalRow[dataIndex] = total
        }
      })
      let taxrate = this.printFn(totalRow['taxRate'] / numberhs)
      let CaO = this.printFn(totalRow['CaO'] / numberhs)
      let MgO = this.printFn(totalRow['MgO'] / numberhs)
      let SiO2 = this.printFn(totalRow['SiO2'] / numberhs)
      let P = this.printFn(totalRow['P'] / numberhs)
      let S = this.printFn(totalRow['S'] / numberhs)
      let CaF2 = this.printFn(totalRow['CaF2'] / numberhs)
      let LD1 = this.printFn(totalRow['LD1'] / numberhs)
      let LD2 = this.printFn(totalRow['LD2'] / numberhs)
      let KCaO = this.printFn(totalRow['KCaO'] / numberhs)
      let KMgO = this.printFn(totalRow['KMgO'] / numberhs)
      let KSiO2 = this.printFn(totalRow['KSiO2'] / numberhs)
      let KP = this.printFn(totalRow['KP'] / numberhs)
      let KS = this.printFn(totalRow['KS'] / numberhs)
      let KCaF2 = this.printFn(totalRow['KCaF2'] / numberhs)
      let KLD1 = this.printFn(totalRow['KLD1'] / numberhs)
      let KLD2 = this.printFn(totalRow['KLD2'] / numberhs)
      let settlemenPrice = this.printFn(totalRow['settlemenPrice'] / numberhs)
      this.taxes = totalRow['taxes']
      if (totalRow['loan'] === '-') {
        this.loan = 0
      } else {
        this.loan = totalRow['loan']
      }
      this.taxes = parseFloat(this.taxes.toFixed(2))
      this.loan = parseFloat(this.loan.toFixed(2))
      this.zprice = this.printFn(this.taxes + this.loan)
      this.zprice = parseFloat(this.zprice.toFixed(2))

      totalRow['CaO'] = '-'
      totalRow['MgO'] = '-'
      totalRow['SiO2'] ='-'
      totalRow['P'] = '-'
      totalRow['S'] = '-'
      totalRow['CaF2'] ='-'
      totalRow['LD1'] = '-'
      totalRow['LD2'] = '-'
      totalRow['KCaO'] = '-'
      totalRow['KMgO'] = '-'
      totalRow['KSiO2'] ='-'
      totalRow['KP'] ='-'
      totalRow['KS'] ='-'
      totalRow['KCaF2'] = '-'
      totalRow['KLD1'] = '-'
      totalRow['KLD2'] = '-'
      totalRow['settlemenPrice'] = '-'
      totalRow['taxRate'] = taxrate
      dataSource.push(totalRow)
    }
  }
}
</script>
<style scoped>
/*update_begin author:scott date:20191203 for:打印机打印的字体模糊问题 */
* {
  color: #000000 !important;
  -webkit-tap-highlight-color: #000000 !important;
}
/*update_end author:scott date:20191203 for:打印机打印的字体模糊问题 */

.abcdefg .ant-card-body {
  margin-left: 0%;
  margin-right: 0%;
  margin-bottom: 1%;
  border: 0px solid black;
  min-width: 1600px;
  color: #000000 !important;
}
.explain {
  text-align: left;
  margin-left: 50px;
  color: #000000 !important;
}
.explain .ant-input,
.sign .ant-input {
  font-weight: bolder;
  text-align: center;
  border-left-width: 0px !important;
  border-top-width: 0px !important;
  border-right-width: 0px !important;
}
.explain div {
  margin-bottom: 10px;
}
/* you can make up upload button and sample style by using stylesheets */
.ant-upload-select-picture-card i {
  font-size: 32px;
  color: #999;
}

.ant-upload-select-picture-card .ant-upload-text {
  margin-top: 8px;
  color: #666;
}
</style>